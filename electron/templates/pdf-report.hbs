<!-- Header -->
<div class="mb-8 border-b pb-4">
    <h1 class="text-2xl font-bold text-gray-700 mb-2">Email QA Report</h1>
    <div class="grid grid-cols-1 gap-4 text-gray-600">
        <div>
            <strong>Subject:</strong> {{#if emailData.subject}}{{emailData.subject}}{{else}}No subject{{/if}}
        </div>
        <div>
            <strong>Filename:</strong> {{emailData.filename}}
        </div>
        <div>
            <strong>Analysis Date:</strong> {{formatDate emailData.updatedAt}}
        </div>
    </div>
</div>

<!-- Email Preview -->
<h2 class="text-xl font-semibold mb-4 text-gray-600">Email Preview</h2>
<div class="mb-6 flex gap-4 justify-between">
    <!-- Desktop Preview -->
    {{#if emailDesktopDataUrl}}
    <div class="mb-6 flex-1">
        <h3 class="text-lg font-medium mb-2 text-gray-600">Desktop View (800px)</h3>
        <img src="{{emailDesktopDataUrl}}" alt="Desktop Email Preview"
            class="border border-gray-300 max-w-full h-auto mb-4" style="max-height: 1200px; object-fit: contain;">
    </div>
    {{/if}}

    <!-- Mobile Preview -->
    {{#if emailMobileDataUrl}}
    <div class="mb-6">
        <h3 class="text-lg font-medium mb-2 text-gray-600">Mobile View (375px)</h3>
        <img src="{{emailMobileDataUrl}}" alt="Mobile Email Preview" class="border border-gray-300 h-auto mb-4"
            style="max-width: 375px; max-height: 1200px; object-fit: contain;">
    </div>
    {{/if}}
</div>

<!-- QA Checklist Section -->
{{#if emailData.qaChecklist.length}}
<div class="page-break mb-8">
    <h2 class="text-xl font-semibold mb-4 text-gray-600">QA Checklist Results</h2>
    <div class="mb-4 p-4 bg-gray-50 rounded border border-gray-200">
        <div class="grid grid-cols-3 gap-4 text-sm">
            <div>
                <strong>Total Items:</strong> {{qaChecklistSummary.totalItems}}
            </div>
            <div>
                <strong>Completed:</strong> {{qaChecklistSummary.completedItems}}
            </div>
            <div>
                <strong>Progress:</strong> <span class="{{getQAChecklistStatusColor qaChecklistSummary.status}}">{{qaChecklistSummary.completionPercentage}}% ({{qaChecklistSummary.status}})</span>
            </div>
        </div>
    </div>
    <div class="space-y-4">
        {{#each emailData.qaChecklist}}
        <div class="border border-gray-200 rounded p-4 {{#if completed}}bg-green-50{{else}}bg-gray-50{{/if}}">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 mt-1">
                    <span
                        class="inline-flex items-center justify-center w-5 h-5 rounded-full text-white text-xs font-medium {{#if completed}}bg-green-500{{else}}bg-gray-400{{/if}}">
                        {{#if completed}}✓{{else}}{{add @index 1}}{{/if}}
                    </span>
                </div>
                <div class="flex-1">
                    <div class="text-sm font-medium text-gray-700 {{#if completed}}line-through{{/if}}">
                        {{itemText}}
                    </div>
                    <div class="text-xs text-gray-600 mt-1">
                        Status: <span class="{{#if completed}}text-green-600{{else}}text-gray-500{{/if}}">{{#if
                            completed}}Completed{{else}}Pending{{/if}}</span>
                    </div>
                    {{#if note}}
                    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm">
                        <strong>Note:</strong> {{note}}
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
        {{/each}}
    </div>
</div>
{{/if}}

<!-- QA Notes Section -->
{{#if emailData.qaNotes.length}}
<div class="mb-8">
    <h2 class="text-xl font-semibold mb-4 text-gray-600">QA Notes</h2>
    <div class="space-y-3">
        {{#each emailData.qaNotes}}
        <div class="border border-gray-200 rounded p-4 bg-blue-50">
            <div class="text-sm text-gray-700">{{content}}</div>
            <div class="text-xs text-gray-500 mt-2">{{formatDate createdAt}}</div>
        </div>
        {{/each}}
    </div>
</div>
{{/if}}

<!-- Attachments Section -->
{{#if emailData.attachments.length}}
<div class="mb-8">
    <h2 class="text-xl font-semibold mb-4 text-gray-600">Attachments</h2>
    <div class="grid grid-cols-2 gap-4">
        {{#each emailData.attachments}}
        <div class="border border-gray-200 rounded p-4 bg-gray-50">
            <div class="text-sm font-medium text-gray-700">{{filename}}</div>
            <div class="text-xs text-gray-500 mt-1">
                <div><strong>Type:</strong> {{mimeType}}</div>
                <div><strong>Size:</strong> {{formatFileSize size}}</div>
            </div>
            {{#if (and mimeType (mimeType.startsWith "image/"))}}
            {{#if (lookup ../attachmentUrls id)}}
            <div class="mt-2">
                <img src="{{lookup ../attachmentUrls id}}" alt="{{filename}}"
                    class="max-w-full h-auto border border-gray-300" style="max-height: 200px; object-fit: contain;">
            </div>
            {{/if}}
            {{/if}}
        </div>
        {{/each}}
    </div>
</div>
{{/if}}

<!-- Links Summary -->
{{#if emailData.links.length}}
<div class="mb-8">
    <h2 class="text-xl font-semibold mb-4 text-gray-600">Links Summary</h2>
    <div class="grid grid-cols-4 gap-4 mb-4">
        <div class="border border-gray-200 rounded p-4 bg-green-50">
            <div class="text-2xl font-bold text-green-600">{{linkStatusSummary.successful}}</div>
            <div class="text-sm text-gray-600">Successful (2xx)</div>
        </div>
        <div class="border border-gray-200 rounded p-4 bg-yellow-50">
            <div class="text-2xl font-bold text-yellow-600">{{linkStatusSummary.redirects}}</div>
            <div class="text-sm text-gray-600">Redirects (3xx)</div>
        </div>
        <div class="border border-gray-200 rounded p-4 bg-red-50">
            <div class="text-2xl font-bold text-red-600">{{linkStatusSummary.failed}}</div>
            <div class="text-sm text-gray-600">Failed (4xx+)</div>
        </div>
        <div class="border border-gray-200 rounded p-4 bg-gray-50">
            <div class="text-2xl font-bold text-gray-600">{{linkStatusSummary.unknown}}</div>
            <div class="text-sm text-gray-600">Unknown</div>
        </div>
    </div>
</div>
{{/if}}

<!-- Detailed Links Analysis -->
{{#if emailData.links.length}}
<div class="mb-8 page-break">
    <h2 class="text-xl font-semibold mb-4 text-gray-600">Detailed Links Analysis</h2>
    {{#each emailData.links}}
    <div class="mb-6 border border-gray-200 rounded p-4 break-inside-avoid">
        <div class="mb-3">
            <h3 class="text-lg font-medium text-gray-700">Link {{add @index 1}}</h3>
            <div class="grid grid-cols-2 gap-4 mt-2 text-sm">
                <div><strong>Link Text:</strong> {{#if text}}{{text}}{{else}}No text{{/if}}</div>
                <div><strong>Status:</strong>
                    <span class="{{getStatusColor status}}">
                        {{#if status}}{{status}}{{else}}N/A{{/if}}
                    </span>
                </div>
                <div class="col-span-2" style="word-break: break-all; max-width: 100%; overflow-wrap: break-word;">
                    <strong>URL:</strong> {{#if url}}{{url}}{{else}}N/A{{/if}}
                </div>
                {{#if (and finalUrl (ne finalUrl url))}}
                <div class="col-span-2" style="word-break: break-all; max-width: 100%; overflow-wrap: break-word;">
                    <strong>Final URL:</strong> {{finalUrl}}
                </div>
                {{/if}}
            </div>
        </div>
        <div class="flex gap-4 justify-between">
            <div class="mb-3 flex-1">
                <h4 class="font-medium text-gray-600 mb-2">UTM Parameters</h4>
                {{#if (hasUtmParams utmParams)}}
                <table class="utm-table text-xs">
                    <thead class="bg-gray-100">
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each utmParams}}
                        <tr>
                            <td class="font-medium">{{@key}}</td>
                            <td>{{this}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
                {{else}}
                <div class="text-sm text-gray-500">No UTM parameters</div>
                {{/if}}
            </div>

            <div>
                <h4 class="font-medium text-gray-600 mb-2">Screenshot</h4>
                {{#if (lookup ../linkScreenshots id)}}
                <img src="{{lookup ../linkScreenshots id}}" alt="Link screenshot"
                    class="border border-gray-300 max-w-full h-auto"
                    style="max-width: 300px; max-height: 200px; object-fit: contain;">
                {{else}}
                <div class="w-[300px] h-[200px] bg-gray-100 rounded border flex items-center justify-center">
                    <span class="text-xs text-gray-500">No screenshot</span>
                </div>
                {{/if}}
            </div>
        </div>
    </div>
    {{/each}}
</div>
{{/if}}

<!-- Detailed Images Analysis -->
{{#if emailData.images.length}}
<div class="mb-8">
    <h2 class="text-xl font-semibold mb-4 text-gray-600">Detailed Images Analysis</h2>
    <div class="mb-4 p-4 bg-gray-50 rounded border border-gray-200">
        <div class="grid grid-cols-3 gap-4 text-sm">
            <div>
                <strong>Total Images:</strong> {{emailData.images.length}}
            </div>
            <div>
                <strong>Successful:</strong> <span class="text-green-600">{{imageStatusSummary.successful}}</span>
            </div>
            <div>
                <strong>Failed:</strong> <span class="text-red-600">{{imageStatusSummary.failed}}</span>
            </div>
        </div>
    </div>
    <table class="utm-table text-xs w-full">
        <thead class="bg-gray-100">
            <tr>
                <th class="text-left">Preview</th>
                <th class="text-left">Alt Text</th>
                <th class="text-left">Status</th>
                <th class="text-left">Dimensions</th>
                <th class="text-left">Source</th>
            </tr>
        </thead>
        <tbody>
            {{#each emailData.images}}
            <tr>
                <td style="width: 80px;">
                    {{#if src}}
                    <img src="{{src}}" alt="{{#if alt}}{{alt}}{{else}}Image preview{{/if}}"
                        style="max-width: 60px; max-height: 60px; object-fit: cover; border: 1px solid #e5e7eb;"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div
                        style="display: none; width: 60px; height: 60px; background: #f3f4f6; border: 1px solid #e5e7eb; align-items: center; justify-content: center; font-size: 10px; color: #6b7280;">
                        No preview
                    </div>
                    {{else}}
                    <div
                        style="width: 60px; height: 60px; background: #f3f4f6; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #6b7280;">
                        No preview
                    </div>
                    {{/if}}
                </td>
                <td style="max-width: 200px; word-break: break-all;">
                    {{#if alt}}{{alt}}{{else}}<em>No alt text</em>{{/if}}
                </td>
                <td>
                    <span class="{{getStatusColor status}}">
                        {{#if status}}{{status}}{{else}}N/A{{/if}}
                    </span>
                </td>
                <td>
                    {{#if (and width height)}}{{width}} × {{height}}{{else}}Unknown{{/if}}
                </td>
                <td style="max-width: 300px; word-break: break-all; font-size: 10px;">
                    {{#if src}}{{src}}{{else}}N/A{{/if}}
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>
{{/if}}

<!-- Spell Check Section -->
{{#if emailData.spellErrors.length}}
<div class="mb-8">
    <h2 class="text-xl font-semibold mb-4 text-gray-600">Spelling & Grammar Check</h2>
    <div class="mb-4 p-4 bg-gray-50 rounded border border-gray-200">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <strong>Total Errors:</strong> {{spellCheckSummary.totalErrors}}
            </div>
            <div>
                <strong>Status:</strong> <span class="{{getSpellCheckStatusColor spellCheckSummary.status}}">{{spellCheckSummary.status}}</span>
            </div>
        </div>
    </div>
    <table class="utm-table text-xs w-full">
        <thead class="bg-gray-100">
            <tr>
                <th class="text-left">Word</th>
                <th class="text-left">Context</th>
                <th class="text-left">Suggestions</th>
            </tr>
        </thead>
        <tbody>
            {{#each emailData.spellErrors}}
            <tr>
                <td class="font-medium text-red-600">{{word}}</td>
                <td style="max-width: 300px;">{{context}}</td>
                <td>{{join (parseSuggestions suggestion) ", "}}</td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>
{{/if}}
